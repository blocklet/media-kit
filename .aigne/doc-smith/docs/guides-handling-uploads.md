# Handling Uploads

Once a file is successfully uploaded, you often need to perform actions on both the server and the client. On the backend, you might save file metadata to a database. On the frontend, you'll want to update the UI with the new file's URL. This guide explains how to use the `onUploadFinish` callbacks in both `@blocklet/uploader-server` and `@blocklet/uploader` to manage the post-upload process.

The entire process involves a coordinated effort between the frontend component and the backend middleware. Here's a high-level overview of the data flow:

```d2
direction: down

User: { 
  shape: c4-person 
}

App: {
  label: "Your Blocklet Application"
  shape: rectangle

  Uploader-Component: {
    label: "Uploader Component"
    shape: rectangle
  }

  Backend-Server: {
    label: "Backend Server"
    shape: rectangle

    Uploader-Server: {
      label: "@blocklet/uploader-server"
      shape: hexagon
    }

    DB: {
      label: "Database"
      shape: cylinder
    }
  }
}

User -> App.Uploader-Component: "1. Drop file"
App.Uploader-Component -> App.Backend-Server.Uploader-Server: "2. Upload file"
App.Backend-Server.Uploader-Server -> App.Backend-Server.Uploader-Server: "3. Backend onUploadFinish"
App.Backend-Server.Uploader-Server -> App.Backend-Server.DB: "4. Save metadata"
App.Backend-Server.DB -> App.Backend-Server.Uploader-Server: "5. Return DB record"
App.Backend-Server.Uploader-Server -> App.Uploader-Component: "6. Send JSON response"
App.Uploader-Component -> App.Uploader-Component: "7. Frontend onUploadFinish"
App.Uploader-Component -> User: "8. Update UI"
```

## Backend: Processing the File with `onUploadFinish`

The `onUploadFinish` callback in the `initLocalStorageServer` configuration is the primary hook for server-side processing. It runs immediately after a file has been fully received and stored in your designated upload directory.

This is the ideal place to:
- Validate the file.
- Save metadata (like filename, size, mimetype) to your database.
- Associate the file with the current user or component.
- Return a JSON response to the frontend with the file's public URL and any other relevant data.

### Implementation

When initializing your middleware, provide an async function to the `onUploadFinish` option.

```javascript
// In your routes/index.js or equivalent backend setup file

import { initLocalStorageServer } from '@blocklet/uploader-server';
import { joinUrl } from 'url-join';

// Assuming 'Upload' is your database model
import Upload from '../models/upload';

const localStorageServer = initLocalStorageServer({
  path: env.uploadDir, // The directory where files are stored
  express,
  onUploadFinish: async (req, res, uploadMetadata) => {
    const {
      id: filename, // The unique, hashed filename on disk
      size,
      metadata: { filename: originalname, filetype: mimetype },
    } = uploadMetadata;

    // Construct the public URL for the file
    const fileUrl = new URL(env.appUrl);
    fileUrl.pathname = joinUrl(req.headers['x-path-prefix'] || '/', '/uploads', filename);

    // Save file information to the database
    const doc = await Upload.insert({
      mimetype,
      originalname,
      filename,
      size,
      url: fileUrl.href,
      folderId: req.componentDid, // Associate with the component
      createdBy: req.user.did,     // Associate with the user
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    });

    // The returned object will be sent as the JSON response to the frontend.
    return doc;
  },
});

router.use('/uploads', user, auth, ensureComponentDid, localStorageServer.handle);
```

### The `uploadMetadata` Object

The `uploadMetadata` object passed to the callback contains crucial information about the completed upload:

| Key | Type | Description |
|---|---|---|
| `id` | `string` | The unique filename generated by the server (e.g., `a1b2c3d4.png`). This is the actual name of the file on the disk. |
| `size` | `number` | The total size of the file in bytes. |
| `metadata` | `object` | An object containing metadata provided by the client. |
| `metadata.filename`| `string` | The original name of the file (e.g., `my-vacation-photo.png`). |
| `metadata.filetype`| `string` | The MIME type of the file (e.g., `image/png`). |
| `runtime.absolutePath` | `string` | The full path to the uploaded file on the server's filesystem. |

## Frontend: Receiving the Result with `onUploadFinish`

The `onUploadFinish` prop on the `<Uploader />` component is a callback function that fires for each successfully uploaded file. It receives the result object, which includes the JSON data returned by your backend handler.

This is the ideal place to:
- Get the final URL of the uploaded file.
- Update your application's state.
- Display the uploaded image or a link to the file.
- Close the uploader modal.

### Implementation

Pass a function to the `onUploadFinish` prop of your `Uploader` component.

```jsx
import { useState } from 'react';
import Uploader from '@blocklet/uploader';

function MyComponent() {
  const [uploadedFiles, setUploadedFiles] = useState([]);

  const handleUploadFinish = (result) => {
    console.log('File uploaded successfully:', result);

    // The `data` property contains the JSON returned from the backend
    const newFile = result.data;

    if (newFile && newFile.url) {
      // Add the new file to our state to display it in the UI
      setUploadedFiles(prevFiles => [...prevFiles, newFile]);
    }
  };

  return (
    <div>
      <Uploader
        onUploadFinish={handleUploadFinish}
        // ... other props
      />
      <div>
        <h3>Uploaded Files:</h3>
        <ul>
          {uploadedFiles.map(file => (
            <li key={file.filename}>
              <a href={file.url} target="_blank" rel="noopener noreferrer">
                {file.originalname}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}
```

### The `result` Object

The `result` object passed to the frontend callback provides context about the upload:

| Key | Type | Description |
|---|---|---|
| `data` | `object` | **Most importantly**, this is the JSON object returned by your backend's `onUploadFinish` function. |
| `uploadURL` | `string` | The final URL of the uploaded file, as constructed by the client. |
| `file` | `object` | The Uppy file object, containing details like `name`, `size`, `type`, and progress. |
| `status` | `number` | The HTTP status code of the final upload request (e.g., `200`). |

By coordinating these two `onUploadFinish` callbacks, you can create a robust and seamless file handling workflow from client to server and back again.

---

Next, learn how to allow users to import files from external services like Unsplash by setting up the Companion middleware.

<x-card data-title="Integrating Remote Sources (Companion)" data-icon="lucide:link" data-href="/guides/remote-sources" data-cta="Read More">
  Set up the Companion middleware to allow users to import files from remote sources like Unsplash and direct URLs.
</x-card>